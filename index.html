<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NBA Trade Value Rankings ‚Äî Hoopsmatic</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0e17;
    --bg-secondary: #111827;
    --bg-card: #151d2e;
    --bg-row-hover: #1a2540;
    --border: #1e2d4a;
    --text-primary: #e8ecf4;
    --text-secondary: #8892a6;
    --text-muted: #555f73;
    --accent-gold: #f0b637;
    --accent-blue: #3b82f6;
    --accent-cyan: #22d3ee;
    --surplus-pos: #10b981;
    --surplus-neg: #ef4444;
    --surplus-neutral: #6b7280;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg-primary); color: var(--text-primary); font-family: 'Source Sans 3', sans-serif; min-height: 100vh; line-height: 1.5; }

  .header { background: linear-gradient(135deg, #0d1321 0%, #172040 50%, #0d1321 100%); border-bottom: 1px solid var(--border); padding: 2.5rem 2rem 2rem; position: relative; overflow: hidden; }
  .header::before { content: ''; position: absolute; top:0;left:0;right:0;bottom:0; background: repeating-linear-gradient(90deg,transparent,transparent 60px,rgba(59,130,246,0.03) 60px,rgba(59,130,246,0.03) 61px); pointer-events: none; }
  .header-inner { max-width: 1400px; margin: 0 auto; position: relative; z-index: 1; }
  .header-brand { display: flex; align-items: baseline; gap: 0.75rem; margin-bottom: 0.25rem; }
  .header-brand h1 { font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 2rem; letter-spacing: 0.05em; text-transform: uppercase; }
  .header-brand .tag { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--accent-gold); background: rgba(240,182,55,0.12); padding: 0.2em 0.6em; border-radius: 3px; letter-spacing: 0.08em; text-transform: uppercase; }
  .header-subtitle { color: var(--text-secondary); font-size: 0.95rem; margin-top: 0.15rem; }

  .stats-bar { max-width: 1400px; margin: -1.5rem auto 0; padding: 0 2rem; position: relative; z-index: 2; display: grid; grid-template-columns: repeat(4,1fr); gap: 1rem; }
  .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.1rem 1.25rem; }
  .stat-card .label { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.3rem; }
  .stat-card .value { font-family: 'Oswald', sans-serif; font-size: 1.5rem; font-weight: 600; }
  .stat-card .value .unit { font-size: 0.85rem; font-weight: 400; color: var(--text-secondary); }

  .controls { max-width: 1400px; margin: 1.75rem auto 0; padding: 0 2rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
  .search-box { flex: 1; min-width: 220px; position: relative; }
  .search-box input { width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 0.65rem 1rem 0.65rem 2.5rem; color: var(--text-primary); font-family: 'Source Sans 3', sans-serif; font-size: 0.9rem; outline: none; transition: border-color 0.2s; }
  .search-box input:focus { border-color: var(--accent-blue); }
  .search-box input::placeholder { color: var(--text-muted); }
  .search-box .icon { position: absolute; left: 0.85rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.85rem; }
  .filter-group { display: flex; gap: 0.5rem; align-items: center; }
  .filter-group label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
  select { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 0.6rem 0.85rem; color: var(--text-primary); font-family: 'Source Sans 3', sans-serif; font-size: 0.85rem; outline: none; cursor: pointer; }
  select:focus { border-color: var(--accent-blue); }

  .table-container { max-width: 1400px; margin: 1.25rem auto 3rem; padding: 0 2rem; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
  thead th { position: sticky; top: 0; z-index: 10; background: var(--bg-secondary); font-family: 'JetBrains Mono', monospace; font-size: 0.68rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); padding: 0.75rem 1rem; text-align: left; border-bottom: 2px solid var(--border); white-space: nowrap; }
  tbody tr { border-bottom: 1px solid rgba(30,45,74,0.5); transition: background 0.15s; }
  tbody tr:hover { background: var(--bg-row-hover); }
  tbody td { padding: 0.7rem 1rem; vertical-align: middle; white-space: nowrap; }

  .col-rank { width: 55px; text-align: center; font-family: 'Oswald', sans-serif; font-weight: 600; font-size: 0.95rem; }
  .rank-top5 { color: var(--accent-gold); }
  .rank-top20 { color: var(--accent-blue); }
  .rank-top50 { color: var(--accent-cyan); }
  .col-player { min-width: 200px; }
  .player-name { font-weight: 600; font-size: 0.92rem; }
  .player-team { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.05rem; }
  .col-num { text-align: right; font-family: 'JetBrains Mono', monospace; font-size: 0.82rem; }
  .col-rat { font-weight: 600; }
  .rat-elite { color: var(--accent-gold); }
  .rat-star { color: var(--accent-blue); }
  .rat-solid { color: var(--accent-cyan); }
  .rat-avg { color: var(--text-primary); }
  .rat-low { color: var(--text-muted); }
  .col-trade-value { font-weight: 700; font-size: 0.85rem; }
  .surplus-pos { color: var(--surplus-pos); }
  .surplus-neg { color: var(--surplus-neg); }
  .surplus-neutral { color: var(--surplus-neutral); }

  .surplus-cell { display: flex; align-items: center; justify-content: flex-end; gap: 0.6rem; }
  .surplus-bar-track { width: 80px; height: 6px; background: rgba(255,255,255,0.04); border-radius: 3px; position: relative; overflow: hidden; }
  .surplus-bar { position: absolute; top: 0; height: 100%; border-radius: 3px; }
  .surplus-bar.positive { left: 50%; background: var(--surplus-pos); }
  .surplus-bar.negative { right: 50%; background: var(--surplus-neg); }
  .surplus-bar-center { position: absolute; left: 50%; top: -1px; bottom: -1px; width: 1px; background: rgba(255,255,255,0.15); }

  .wm-detail { position: relative; cursor: help; }
  .wm-detail .wm-tooltip { display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: #1a2540; border: 1px solid var(--border); border-radius: 6px; padding: 0.6rem 0.85rem; z-index: 20; white-space: nowrap; font-size: 0.72rem; color: var(--text-secondary); line-height: 1.7; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
  .wm-detail:hover .wm-tooltip { display: block; }
  .wm-tooltip .tt-label { color: var(--text-muted); }
  .wm-tooltip .tt-val { color: var(--text-primary); font-weight: 500; }

  .methodology { max-width: 1400px; margin: 0 auto 3rem; padding: 0 2rem; }
  .method-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.75rem 2rem; }
  .method-card h3 { font-family: 'Oswald', sans-serif; font-size: 1.05rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-secondary); margin-bottom: 0.75rem; }
  .method-card p { color: var(--text-secondary); font-size: 0.88rem; line-height: 1.65; max-width: 960px; }
  .method-card p + p { margin-top: 0.6rem; }
  .method-card code { font-family: 'JetBrains Mono', monospace; font-size: 0.82rem; color: var(--accent-cyan); background: rgba(34,211,238,0.08); padding: 0.15em 0.4em; border-radius: 3px; }
  .formula-block { background: rgba(0,0,0,0.25); border: 1px solid var(--border); border-radius: 6px; padding: 1rem 1.25rem; margin-top: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.82rem; color: var(--accent-cyan); line-height: 1.8; }
  .formula-block .step-label { color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; }

  .loading-overlay { max-width: 1400px; margin: 4rem auto; padding: 0 2rem; text-align: center; }
  .loading-overlay .spinner { display: inline-block; width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 1rem; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-overlay p { color: var(--text-secondary); font-size: 0.9rem; }
  .error-msg { color: var(--surplus-neg); max-width: 600px; margin: 0 auto; text-align: center; }

  .footer { max-width: 1400px; margin: 0 auto; padding: 1.5rem 2rem 2.5rem; text-align: center; font-size: 0.75rem; color: var(--text-muted); border-top: 1px solid var(--border); }

  @media (max-width: 900px) { .stats-bar { grid-template-columns: repeat(2,1fr); } .controls { flex-direction: column; } .search-box { min-width: 100%; } }
  @media (max-width: 600px) { .stats-bar { grid-template-columns: 1fr 1fr; gap: 0.5rem; } .stat-card { padding: 0.85rem 1rem; } .stat-card .value { font-size: 1.2rem; } .header { padding: 1.5rem 1rem 1.25rem; } .header-brand h1 { font-size: 1.4rem; } .table-container { padding: 0 0.5rem; } .surplus-bar-track { display: none; } td, th { padding: 0.5rem 0.6rem; } }
  tbody tr { animation: fadeInRow 0.25s ease both; }
  @keyframes fadeInRow { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div class="header-brand">
      <h1>NBA Trade Value Rankings</h1>
      <span class="tag">v1.5</span>
    </div>
    <p class="header-subtitle">Watermark (75%) + RAT 365 (25%) + Age Factor (¬±20%) ‚Äî fixed league salary pool, progressive exponent</p>
  </div>
</div>

<div class="stats-bar" id="statsBar">
  <div class="stat-card"><div class="label">Loading...</div><div class="value">‚Äî</div></div>
  <div class="stat-card"><div class="label">Loading...</div><div class="value">‚Äî</div></div>
  <div class="stat-card"><div class="label">Loading...</div><div class="value">‚Äî</div></div>
  <div class="stat-card"><div class="label">Loading...</div><div class="value">‚Äî</div></div>
</div>

<div class="controls">
  <div class="search-box">
    <span class="icon">üîç</span>
    <input type="text" id="searchInput" placeholder="Search player or team..." disabled>
  </div>
  <div class="filter-group">
    <label>Team</label>
    <select id="teamFilter" disabled><option value="">All Teams</option></select>
  </div>
  <div class="filter-group">
    <label>Sort</label>
    <select id="sortSelect" disabled>
      <option value="uncappedTV-desc">Trade Value ‚Üì</option>
      <option value="uncappedTV-asc">Trade Value ‚Üë</option>
      <option value="surplus-desc">Surplus ‚Üì</option>
      <option value="surplus-asc">Surplus ‚Üë</option>
      <option value="watermark-desc">Watermark ‚Üì</option>
      <option value="watermark-asc">Watermark ‚Üë</option>
      <option value="rat365-desc">RAT 365 ‚Üì</option>
      <option value="rat365-asc">RAT 365 ‚Üë</option>
      <option value="salary-desc">Salary ‚Üì</option>
      <option value="salary-asc">Salary ‚Üë</option>
      <option value="age-asc">Age ‚Üë (youngest)</option>
      <option value="age-desc">Age ‚Üì (oldest)</option>
    </select>
  </div>
</div>

<div id="loadingArea">
  <div class="loading-overlay">
    <div class="spinner"></div>
    <p>Fetching live data from Google Sheets...</p>
  </div>
</div>

<div class="table-container" style="display:none" id="tableContainer">
  <table>
    <thead>
      <tr>
        <th class="col-rank">#</th>
        <th>Player</th>
        <th style="text-align:right">Age</th>
        <th style="text-align:right">RAT 365</th>
        <th style="text-align:right">Watermark</th>
        <th style="text-align:right">Salary</th>
        <th style="text-align:right">Trade Value</th>
        <th style="text-align:right">Surplus</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div class="methodology">
  <div class="method-card">
    <h3>Methodology</h3>
    <p>Trade values are distributed from a <strong style="color:var(--text-primary)">fixed salary pool</strong> equal to the sum of every current NBA salary. No money is created or removed ‚Äî the system only redistributes existing salary based on performance.</p>
    <p>The <strong style="color:var(--text-primary)">Watermark</strong> rating uses a time-decay weighted average: each game's per-game RAT contributes weighted by its season's recency ‚Äî 2025-26 at full weight (1.0), then decaying by 0.6√ó per year back (0.6, 0.36, 0.216, 0.13). Recent performance matters most while still crediting a strong track record. Hover over any Watermark to see the per-season breakdown.</p>
    <p>The final Trade Value is an <strong style="color:var(--text-primary)">85/15 blend</strong>: 85% from the Watermark-based distribution and 15% from the RAT 365-based distribution. Both distributions use an exponent of <code>1.8</code>, creating a steep progressive curve where elite production is rewarded exponentially.</p>
    <p>A <strong style="color:var(--text-primary)">games-played correction</strong> is applied per-season to compensate for the Global Rating's built-in availability penalty. For each season, the per-game average is adjusted by <code>(expected / actual)^0.8</code>, capped at 1.4√ó and only for players with ‚â•40% of expected games. The same correction is applied to RAT 365.</p>
    <p>An <strong style="color:var(--text-primary)">age factor</strong> rewards youth and mildly penalizes age. Players below the league average age (~26.5) receive up to a 2√ó bonus scaling linearly to the youngest player. Players 35 and older receive a 3% penalty per year over 35 (floor 0.5√ó). Players between average and 35 are unaffected. After all adjustments, values are renormalized so the total still equals the salary pool.</p>
    <div class="formula-block">
      <span class="step-label">Step 1</span>&nbsp; Watermark = Œ£(weight √ó games √ó corrected RAT/g) √∑ Œ£(weight √ó games) ‚Äî time-decay per season<br>
      <span class="step-label">Step 2</span>&nbsp; Per-season GP correction: adj/g = raw/g √ó min(1.4, (expected/actual)^0.8)<br>
      <span class="step-label">Step 3</span>&nbsp; TV<sub>WM</sub> = (Watermark^1.8 √∑ Œ£) √ó Pool &nbsp;|&nbsp; TV<sub>RAT</sub> = (adj RAT365^1.8 √∑ Œ£) √ó Pool<br>
      <span class="step-label">Step 4</span>&nbsp; TV<sub>blend</sub> = 85% √ó TV<sub>WM</sub> + 15% √ó TV<sub>RAT</sub><br>
      <span class="step-label">Step 5</span>&nbsp; Age factor (youth +100%, 35+ ‚àí3%/yr) ‚Üí normalize to Pool = Trade Value
    </div>
  </div>
</div>

<div class="footer">Hoopsmatic ‚Äî NBA Trade Value Rankings v1.5 ‚Äî Data fetched live from Google Sheets</div>

<script>
const SHEET_ID = '2PACX-1vSg6im6IYB6HXMGzQbmmBnLw9SfQLzxCSo8OfChxlJLhsB6BBCO0wPF_TMch0YgAbtFqYkwDWrsxRe7';
const GID = '1310971167';
const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=${GID}&single=true&output=csv`;
const EXPONENT = 1.8;
const WM_WEIGHT = 0.85;
const RAT_WEIGHT = 0.15;
const AGE_MAX_BONUS = 1.0;
const OLD_THRESHOLD = 35;
const OLD_PENALTY_PER_YEAR = 0.03;
const OLD_FLOOR = 0.50;
const GAMES_BETA = 0.8;
const GAMES_MAX_MULT = 1.4;
const GAMES_MIN_PCT = 0.40;

// NBA 2025-26 salary floor (minimums) and ceiling (max) by experience
const SAL_CAP = 154647000;
const MIN_SAL = {0:1272870,1:2048494,2:2296274,3:2378870,4:2461463,5:2667947,6:2874436,7:3080921,8:3287409,9:3303774};
const MIN_SAL_10 = 3634153;
const MAX_SAL = {0:Math.round(SAL_CAP*0.25),7:Math.round(SAL_CAP*0.30),10:Math.round(SAL_CAP*0.35)};
const TWO_WAY_SAL = 636435;
function getMinSal(exp) { if (exp <= 3) return TWO_WAY_SAL; return exp >= 10 ? MIN_SAL_10 : (MIN_SAL[exp] || MIN_SAL[0]); }
function getMaxSal(exp) { if (exp >= 10) return MAX_SAL[10]; if (exp >= 7) return MAX_SAL[7]; return MAX_SAL[0]; }

function parseCSV(text) {
  const rows = []; let current = '', inQuotes = false, row = [];
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (inQuotes) {
      if (ch === '"' && text[i+1] === '"') { current += '"'; i++; }
      else if (ch === '"') inQuotes = false;
      else current += ch;
    } else {
      if (ch === '"') inQuotes = true;
      else if (ch === ',') { row.push(current.trim()); current = ''; }
      else if (ch === '\n' || ch === '\r') {
        if (ch === '\r' && text[i+1] === '\n') i++;
        row.push(current.trim());
        if (row.length > 1 || row[0] !== '') rows.push(row);
        row = []; current = '';
      } else current += ch;
    }
  }
  if (current || row.length > 0) { row.push(current.trim()); if (row.length > 1 || row[0] !== '') rows.push(row); }
  return rows;
}

function processData(rows) {
  const dataRows = rows.slice(1);
  const roster = [], historical = [];
  let todayStr = null;
  const shootingMap = {};
  const expMap = {};

  for (const row of dataRows) {
    while (row.length < 21) row.push('');
    // Grab today's date from col S (index 18)
    if (row[18] && !todayStr) todayStr = row[18];
    if (row[0] && row[1]) {
      roster.push({ team: row[0], player: row[1], rat365: parseFloat(row[2]) || 0, salary: parseInt(row[3].replace(/[$,]/g,'')) || 0, birthday: row[4] || '' });
      // EXP column (index 19)
      if (row[19]) { const ev = parseInt(row[19]); if (!isNaN(ev)) expMap[row[1].trim()] = ev; }
    }
    if (row[6] && row[7]) {
      const g = parseInt(row[9]) || 0;
      if (g > 0) historical.push({ year: row[6], player: row[7], totalRat: parseFloat(row[8].replace(/,/g,'')) || 0, games: g });
    }
    // Shooting penalty (col 12=player, col 17=shooting, 2025-26 block)
    if (row[12] && row[17]) {
      const sv = parseFloat(row[17]);
      if (!isNaN(sv) && sv > 0) shootingMap[row[12].trim()] = sv;
    }
  }

  const playerHist = {};
  for (const h of historical) { if (!playerHist[h.player]) playerHist[h.player] = []; playerHist[h.player].push(h); }

  const totalSalaryPool = roster.reduce((s,p) => s + p.salary, 0);

  const SEASON_WEIGHT = {'2025-26':1.0,'2024-25':0.6,'2023-24':0.36,'2022-23':0.216,'2021-22':0.1296};
  const CUR_YEAR = '2025-26';
  const EXPECTED = {'2021-22':82,'2022-23':82,'2023-24':82,'2024-25':82,'2025-26':48};

  for (const p of roster) {
    const hist = playerHist[p.player] || [];
    let num = 0, den = 0;
    for (const h of hist) {
      const w = SEASON_WEIGHT[h.year] || 0;
      if (w <= 0 || h.games <= 0) continue;
      let perGame = h.totalRat / h.games;
      // Per-season games correction
      const exp = EXPECTED[h.year] || 82;
      const pct = h.games / exp;
      if (pct >= GAMES_MIN_PCT) perGame *= Math.min(GAMES_MAX_MULT, Math.pow(exp / h.games, GAMES_BETA));
      num += perGame * w * h.games;
      den += w * h.games;
    }
    p.watermark = den > 0 ? num / den : 0;

    const cur = hist.filter(h => h.year === CUR_YEAR);
    p.curGames = cur.reduce((s,h) => s+h.games, 0);
    p.expGames = EXPECTED[CUR_YEAR];
    if (p.curGames > 0 && (p.curGames/p.expGames) >= GAMES_MIN_PCT) {
      p.gamesCorr = Math.min(GAMES_MAX_MULT, Math.pow(p.expGames/p.curGames, GAMES_BETA));
    } else { p.gamesCorr = 1.0; }

    // Season weights for tooltip
    const yrs = [...new Set(hist.map(h => h.year))].sort();
    p.seasonInfo = yrs.map(yr => {
      const yh = hist.filter(h => h.year === yr);
      const g = yh.reduce((s,h) => s+h.games, 0);
      const r = yh.reduce((s,h) => s+h.totalRat, 0);
      const w = SEASON_WEIGHT[yr] || 0;
      return { year: yr, avg: g > 0 ? r/g : 0, games: g, weight: w };
    }).filter(s => s.weight > 0);

    // Games-corrected RAT 365
    if (p.curGames > 0) {
      const pct = p.curGames / EXPECTED[CUR_YEAR];
      p.rat365adj = pct >= GAMES_MIN_PCT ? p.rat365 * Math.min(GAMES_MAX_MULT, Math.pow(EXPECTED[CUR_YEAR]/p.curGames, GAMES_BETA)) : p.rat365;
    } else {
      const prev = hist.filter(h => h.year === '2024-25');
      const pg = prev.reduce((s,h) => s+h.games, 0) || 82;
      const pct = pg / 82;
      p.rat365adj = pct >= GAMES_MIN_PCT ? p.rat365 * Math.min(GAMES_MAX_MULT, Math.pow(82/pg, GAMES_BETA)) : p.rat365;
    }
  }
  function parseDate(s) {
    if (!s) return null;
    const parts = s.split('/');
    if (parts.length === 3) return new Date(+parts[2], +parts[0]-1, +parts[1]);
    return null;
  }
  const today = parseDate(todayStr) || new Date();
  const ages = [];
  for (const p of roster) {
    const bd = parseDate(p.birthday);
    if (bd) {
      p.age = (today - bd) / (365.25 * 24 * 60 * 60 * 1000);
      ages.push(p.age);
    } else {
      p.age = null;
    }
  }
  const avgAge = ages.length > 0 ? ages.reduce((a,b) => a+b, 0) / ages.length : 26;
  const maxDevYoung = avgAge - Math.min(...ages);

  // Age multiplier: youth bonus below avg, mild penalty above 35
  for (const p of roster) {
    if (p.age !== null && p.age < avgAge) {
      p.ageMult = 1.0 + AGE_MAX_BONUS * (avgAge - p.age) / maxDevYoung;
    } else if (p.age !== null && p.age >= OLD_THRESHOLD) {
      p.ageMult = Math.max(OLD_FLOOR, 1.0 - OLD_PENALTY_PER_YEAR * (p.age - OLD_THRESHOLD));
    } else {
      p.ageMult = 1.0;
    }
  }

  // Trade value: 85/15 blend √ó age multiplier √ó shooting penalty, then renormalize to pool
  const totalAdjWM = roster.reduce((s,p) => s + Math.pow(Math.max(p.watermark,0), EXPONENT), 0);
  const totalAdjRAT = roster.reduce((s,p) => s + Math.pow(Math.max(p.rat365adj,0), EXPONENT), 0);
  for (const p of roster) {
    const tvWM = (Math.pow(Math.max(p.watermark,0), EXPONENT) / totalAdjWM) * totalSalaryPool;
    const tvRAT = (Math.pow(Math.max(p.rat365adj,0), EXPONENT) / totalAdjRAT) * totalSalaryPool;
    p.tvPreAge = WM_WEIGHT * tvWM + RAT_WEIGHT * tvRAT;
    // Shooting penalty: decrease by (value √ó 100)%
    p.shootingPenalty = (shootingMap[p.player] || 0) * 2;
    p.shootingMult = 1 - p.shootingPenalty;
    p.tvWithAge = p.tvPreAge * p.ageMult * p.shootingMult;
  }
  const totalWithAge = roster.reduce((s,p) => s + p.tvWithAge, 0);
  for (const p of roster) {
    p.uncappedTV = Math.round((p.tvWithAge / totalWithAge) * totalSalaryPool);
    p.exp = (expMap[p.player] !== undefined) ? expMap[p.player] : null;
    p.salFloor = p.exp !== null ? getMinSal(p.exp) : null;
    p.salCeil = p.exp !== null ? getMaxSal(p.exp) : null;
    p.capped = false;
    p.floored = false;
    if (p.exp !== null && p.uncappedTV > p.salCeil) { p.tradeValue = p.salCeil; p.capped = true; }
    else if (p.exp !== null && p.uncappedTV < p.salFloor) { p.tradeValue = p.salFloor; p.floored = true; }
    else { p.tradeValue = p.uncappedTV; }
    p.surplus = p.tradeValue - p.salary;
  }
  // Rank by uncapped (real) value
  roster.sort((a,b) => b.uncappedTV - a.uncappedTV);
  roster.forEach((p,i) => p.rank = i+1);

  return { players: roster, totalSalaryPool, exponent: EXPONENT, avgAge };
}

let appData = null;

function fmt$(n) { const a=Math.abs(n); if(a>=1e6)return(n<0?'-':'')+'$'+(a/1e6).toFixed(1)+'M'; if(a>=1e3)return(n<0?'-':'')+'$'+(a/1e3).toFixed(0)+'K'; return '$'+n.toLocaleString(); }
function fmtFull$(n) { return (n<0?'-$':'$')+Math.abs(n).toLocaleString(); }
function ratCls(r) { return r>=18?'rat-elite':r>=12?'rat-star':r>=6?'rat-solid':r>=2?'rat-avg':'rat-low'; }
function rankCls(r) { return r<=5?'rank-top5':r<=20?'rank-top20':r<=50?'rank-top50':''; }
function surpCls(s) { return s>5e5?'surplus-pos':s<-5e5?'surplus-neg':'surplus-neutral'; }

function buildStats(d) {
  const avgWM = d.players.reduce((s,p) => s+p.watermark, 0) / d.players.length;
  document.getElementById('statsBar').innerHTML = [
    {l:'Salary Pool',v:'$'+(d.totalSalaryPool/1e9).toFixed(2),u:'B'},
    {l:'Players Ranked',v:d.players.length,u:''},
    {l:'Avg Age',v:d.avgAge.toFixed(1),u:' yrs'},
    {l:'Formula',v:'85/15',u:' + youth age + GP'}
  ].map(s=>`<div class="stat-card"><div class="label">${s.l}</div><div class="value">${s.v}<span class="unit">${s.u}</span></div></div>`).join('');
}

function buildTeams(d) {
  const sel = document.getElementById('teamFilter');
  sel.innerHTML = '<option value="">All Teams</option>';
  [...new Set(d.players.map(p=>p.team))].sort().forEach(t => { const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); });
}

function renderTable(players) {
  const maxS = Math.max(...appData.players.map(p=>Math.abs(p.surplus)));
  document.getElementById('tableBody').innerHTML = players.map((p,i) => {
    const pct = Math.min(Math.abs(p.surplus)/maxS*50, 50);
    const bc = p.surplus>=0?'positive':'negative';
    return `<tr style="animation-delay:${Math.min(i*0.015,0.4)}s">
      <td class="col-rank ${rankCls(p.rank)}">${p.rank}</td>
      <td class="col-player"><div class="player-name">${p.player}</div><div class="player-team">${p.team}</div></td>
      <td class="col-num wm-detail" style="color:${p.ageMult>=1?'var(--surplus-pos)':'var(--surplus-neg)'}">${p.age!==null?p.age.toFixed(1):'‚Äî'}<div class="wm-tooltip"><span class="tt-label">Age mult:</span> <span class="tt-val">${p.ageMult.toFixed(3)}x</span><br><span class="tt-label">GP (cur):</span> <span class="tt-val">${p.curGames}/${p.expGames}</span><br><span class="tt-label">Games corr:</span> <span class="tt-val">${p.gamesCorr.toFixed(3)}x</span>${p.shootingPenalty > 0 ? `<br><span class="tt-label">Shooting:</span> <span class="tt-val" style="color:var(--surplus-neg)">-${(p.shootingPenalty*100).toFixed(2)}%</span>` : ''}</div></td>
      <td class="col-num col-rat ${ratCls(p.rat365)}">${p.rat365.toFixed(2)}</td>
      <td class="col-num col-rat wm-detail ${ratCls(p.watermark)}">${p.watermark.toFixed(2)}<div class="wm-tooltip">${p.seasonInfo.map(s=>`<span class="tt-label">${s.year} (√ó${s.weight}):</span> <span class="tt-val">${s.avg.toFixed(1)}/g</span> ${s.games}gp`).join('<br>') || 'No data'}</div></td>
      <td class="col-num">${fmtFull$(p.salary)}</td>
      <td class="col-num col-trade-value">${fmtFull$(p.tradeValue)}${p.capped ? `<div style="font-size:0.65rem;color:var(--text-muted);margin-top:1px">MAX ¬∑ real: ${fmt$(p.uncappedTV)}</div>` : ''}${p.floored ? `<div style="font-size:0.65rem;color:var(--text-muted);margin-top:1px">MIN</div>` : ''}</td>
      <td class="col-num col-surplus"><div class="surplus-cell"><div class="surplus-bar-track"><div class="surplus-bar-center"></div><div class="surplus-bar ${bc}" style="width:${pct}%"></div></div><span class="${surpCls(p.surplus)}">${p.surplus>=0?'+':''}${fmt$(p.surplus)}</span></div></td>
    </tr>`;
  }).join('');
}

function update() {
  if (!appData) return;
  const search = document.getElementById('searchInput').value.toLowerCase();
  const team = document.getElementById('teamFilter').value;
  const [sortKey, sortDir] = document.getElementById('sortSelect').value.split('-');
  let f = appData.players.filter(p => {
    if (team && p.team !== team) return false;
    if (search && !p.player.toLowerCase().includes(search) && !p.team.toLowerCase().includes(search)) return false;
    return true;
  });
  const dir = sortDir==='desc'?-1:1;
  f.sort((a,b) => {
    const av = a[sortKey], bv = b[sortKey];
    if (av === null && bv === null) return 0;
    if (av === null) return 1;
    if (bv === null) return -1;
    return (av - bv) * dir;
  });
  renderTable(f);
}

async function init() {
  try {
    const res = await fetch(CSV_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    appData = processData(parseCSV(text));

    document.getElementById('loadingArea').style.display = 'none';
    document.getElementById('tableContainer').style.display = 'block';
    document.getElementById('searchInput').disabled = false;
    document.getElementById('teamFilter').disabled = false;
    document.getElementById('sortSelect').disabled = false;

    buildStats(appData);
    buildTeams(appData);
    update();

    document.getElementById('searchInput').addEventListener('input', update);
    document.getElementById('teamFilter').addEventListener('change', update);
    document.getElementById('sortSelect').addEventListener('change', update);
  } catch(err) {
    document.getElementById('loadingArea').innerHTML =
      `<div class="error-msg"><p>‚ö†Ô∏è Failed to fetch data: ${err.message}</p><p style="color:var(--text-muted);margin-top:0.5rem;font-size:0.85rem;">Make sure the Google Sheet is published: File ‚Üí Share ‚Üí Publish to web ‚Üí Entire Document</p></div>`;
  }
}
init();
</script>
</body>
</html>
